name: CI/CD with Docker Compose

# Trigger workflow on push to main branch or manual trigger
on:
  push:
    branches:
      - master
  workflow_dispatch:   # امکان Run دستی از GitHub UI

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    needs: test 

    steps:
      # 1️⃣ Checkout repository code
      - name: Checkout code
        uses: actions/checkout@v4

      # 2️⃣ Set up Docker Buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 3️⃣ Install Docker Compose (اگر لازم باشد)
      - name: Install Docker Compose
        run: |
          sudo apt-get update
          sudo apt-get install -y docker-compose

      # 4️⃣ Set environment variables from GitHub Secrets
      - name: Set environment variables
        run: |
          echo "SA_PASSWORD=${{ secrets.SQL_PASSWORD }}" >> $GITHUB_ENV
          echo "DB_NAME=${{ secrets.DB_NAME }}" >> $GITHUB_ENV

      # 5️⃣ Stop previous containers (Cleanup)
      - name: Stop and remove previous containers
        run: |
          docker-compose -f docker-compose.yml down

      # 6️⃣ Build and run containers
      - name: Build and run containers
        run: |
          docker-compose -f docker-compose.yml up -d --build

      # 7️⃣ Show running containers (برای debug)
      - name: List running containers
        run: docker ps
 
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run tests
        run: |
          echo "Running tests..."
          # مثلا:
          # dotnet test
          # npm test

  run-on-github:
    runs-on: ubuntu-latest
    needs: build-and-deploy   # اگر میخوای بعد از build اجرا بشه
    steps:

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Docker Compose
        run: |
          sudo apt-get update
          sudo apt-get install -y docker-compose

      - name: Set environment variables
        run: |
          echo "SA_PASSWORD=${{ secrets.SQL_PASSWORD }}" >> $GITHUB_ENV
          echo "DB_NAME=${{ secrets.DB_NAME }}" >> $GITHUB_ENV

      - name: Run containers
        run: |
          docker-compose up -d --build

      - name: Wait for app to start
        run: sleep 15

      - name: Check running containers
        run: docker ps

      - name: Test application
        run: curl http://localhost:5000

 
